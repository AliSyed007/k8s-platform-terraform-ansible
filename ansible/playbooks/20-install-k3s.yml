---
- name: Install k3s (single-node, hardened for t3.micro)
  hosts: k3s
  become: true
  gather_facts: true
  any_errors_fatal: true

  vars:
    k3s_version: "v1.29.6+k3s2"

  tasks:
    - name: Ensure curl exists
      ansible.builtin.apt:
        name: curl
        state: present

    - name: Install k3s server
      ansible.builtin.shell: |
        curl -sfL https://get.k3s.io | \
        INSTALL_K3S_VERSION={{ k3s_version }} \
        INSTALL_K3S_EXEC="server \
          --disable traefik \
          --disable servicelb \
          --disable metrics-server \
          --write-kubeconfig-mode 600 \
          --bind-address 127.0.0.1 \
          --advertise-address 127.0.0.1 \
          --tls-san 127.0.0.1" \
        sh -
      args:
        creates: /usr/local/bin/k3s

    - name: Wait for k3s service
      ansible.builtin.systemd:
        name: k3s
        state: started
        enabled: true

    - name: Wait for API server to respond
      ansible.builtin.command: k3s kubectl get nodes
      register: kubectl_out
      retries: 10
      delay: 10
      until: kubectl_out.rc == 0
      changed_when: false

    - name: Gate - Node must be Ready
      ansible.builtin.command: k3s kubectl get nodes --no-headers
      register: node_status
      changed_when: false

    - name: Assert node is Ready
      ansible.builtin.assert:
        that:
          - "' Ready ' in node_status.stdout"
        fail_msg: "Node is not Ready. Investigate before proceeding."
        success_msg: "k3s control plane is Ready."
